---
title: "General report of motif_analysis pipelines"
output: html_notebook
---

This notebook resumes motif sequences obtained from the different motif pipeline: <br>
 - a549_slam <br>
 - a549_tripseq <br>
 - hepg2_slam <br>
 - hepg2_tripseq <br>

```{r setup, echo=FALSE}
library(stringr)
library(tidyverse)
library(Biostrings)
library(msa)

out_dir = "/mnt/sharc/shared/sudlab1/General/projects/SynthUTR_hepG2_a549/motif_merge_linkers/final_linkers/"
```

##Coding 

Load source tables

```{r load, echo=F}
#A549
a549_slam_one_high <- read.delim("/mnt/sharc/shared/sudlab1/General/projects/SynthUTR_hepG2_a549/a549_slam/motif_analysis/one_transcript/final_motifs/highstab_final_motifs.list.source", header = T, sep = " ")

a549_slam_one_low <- read.delim("/mnt/sharc/shared/sudlab1/General/projects/SynthUTR_hepG2_a549/a549_slam/motif_analysis/one_transcript/final_motifs/lowstab_final_motifs.list.source", header = T, sep = " ")

a549_slam_all_high <- read.delim("/mnt/sharc/shared/sudlab1/General/projects/SynthUTR_hepG2_a549/a549_slam/motif_analysis/all_transcripts/final_motifs/highstab_final_motifs.list.source", header = T, sep = " ")
a549_slam_all_low <- read.delim("/mnt/sharc/shared/sudlab1/General/projects/SynthUTR_hepG2_a549/a549_slam/motif_analysis/all_transcripts/final_motifs/lowstab_final_motifs.list.source", header = T, sep = " ")

a549_tripseq_one_high <- read.delim("/mnt/sharc/shared/sudlab1/General/projects/SynthUTR_hepG2_a549/a549_tripseq/motif_analysis/one_transcript/final_motifs/highstab_final_motifs.list.source", header = T, sep = " ")
a549_tripseq_one_low <- read.delim("/mnt/sharc/shared/sudlab1/General/projects/SynthUTR_hepG2_a549/a549_tripseq/motif_analysis/one_transcript/final_motifs/lowstab_final_motifs.list.source", header = T, sep = " ")

a549_tripseq_all_high <- read.delim("/mnt/sharc/shared/sudlab1/General/projects/SynthUTR_hepG2_a549/a549_tripseq/motif_analysis/all_transcripts/final_motifs/highstab_final_motifs.list.source", header =T, sep = " ")
a549_tripseq_all_low <- read.delim("/mnt/sharc/shared/sudlab1/General/projects/SynthUTR_hepG2_a549/a549_tripseq/motif_analysis/all_transcripts/final_motifs/lowstab_final_motifs.list.source", header =T, sep = " ")


#HepG2
hepg2_slam_one_high <- read.delim("/mnt/sharc/shared/sudlab1/General/projects/SynthUTR_hepG2_a549/hepg2_slam/motif_analysis/one_transcript/final_motifs/highstab_final_motifs.list.source", header = T, sep = " ")
hepg2_slam_one_low <- read.delim("/mnt/sharc/shared/sudlab1/General/projects/SynthUTR_hepG2_a549/hepg2_slam/motif_analysis/one_transcript/final_motifs/lowstab_final_motifs.list.source", header = T, sep = " ")

hepg2_slam_all_high <- read.delim("/mnt/sharc/shared/sudlab1/General/projects/SynthUTR_hepG2_a549/hepg2_slam/motif_analysis/all_transcripts/final_motifs/highstab_final_motifs.list.source", header = T, sep = " ")
hepg2_slam_all_low <- read.delim("/mnt/sharc/shared/sudlab1/General/projects/SynthUTR_hepG2_a549/hepg2_slam/motif_analysis/all_transcripts/final_motifs/lowstab_final_motifs.list.source", header = T, sep = " ")

hepg2_tripseq_one_high <- read.delim("/mnt/sharc/shared/sudlab1/General/projects/SynthUTR_hepG2_a549/hepg2_tripseq/motif_analysis/one_transcript/final_motifs/highstab_final_motifs.list.source", header = T, sep = " ")
hepg2_tripseq_one_low <- read.delim("/mnt/sharc/shared/sudlab1/General/projects/SynthUTR_hepG2_a549/hepg2_tripseq/motif_analysis/one_transcript/final_motifs/lowstab_final_motifs.list.source", header = T, sep = " ")

hepg2_tripseq_all_high <- read.delim("/mnt/sharc/shared/sudlab1/General/projects/SynthUTR_hepG2_a549/hepg2_tripseq/motif_analysis/all_transcripts/final_motifs/highstab_final_motifs.list.source", header =T, sep = " ")
hepg2_tripseq_all_low <- read.delim("/mnt/sharc/shared/sudlab1/General/projects/SynthUTR_hepG2_a549/hepg2_tripseq/motif_analysis/all_transcripts/final_motifs/lowstab_final_motifs.list.source", header =T, sep = " ")

my_msa <- function (x, my_method) {
  seq_msa <- msa(BStringSet(x),method = my_method,
                type = "rna")
  consensus <- msaConsensusSequence(seq_msa)
  return(consensus)
}

```


Cluster motifs

```{r cluster, echo=FALSE, warning=FALSE, message=FALSE}
highstab_seq <- c(a549_slam_all_high[,2],
                  a549_slam_one_high[,2],
                  a549_tripseq_all_high[,2],
                  a549_tripseq_one_high[,2],
                  hepg2_slam_all_high[,2],
                  hepg2_slam_one_high[,2],
                  hepg2_tripseq_all_high[,2],
                  hepg2_tripseq_one_high[,2]) %>%
  unique()

#No strings of 6 Gs, As, Us, Cs
notOK <- c(highstab_seq[str_detect(highstab_seq, "AAAAAA")],
           highstab_seq[str_detect(highstab_seq, "GGGGGG")],
           highstab_seq[str_detect(highstab_seq, "UUUUUU")],
           highstab_seq[str_detect(highstab_seq, "CCCCCC")])


highstab_seq <- highstab_seq[!(highstab_seq %in% notOK)]

#Get motifs matching each other
self_match_high <- sapply(highstab_seq, function(i) highstab_seq[str_detect(highstab_seq, i)])

#No match
final_high <- self_match_high[lapply(self_match_high, length) == 1]

#Matches
several_high <- self_match_high[lapply(self_match_high,length) >1]

#If only matches by 2
if ( all(lapply(several_high,  length) ==  2)) {
  #No need to cluster, keep final, it keeps the longest
  list_several_high <- lapply(several_high, min) %>% do.call(c, .)
  highstab_final <- final_high %>% do.call(c, .) %>% c(., list_several_high) %>%
  unique()
} else {

#Cluster them
clustered_high <- sapply(several_high, 
                    function(x) unique(unlist(several_high[sapply(several_high, 
                                                             function(y) any(x %in% y))]))) %>% unique

#Multiple aligment and fetch consensus of aligment
msa_consensus_high <- lapply(clustered_high, function(x) my_msa(x, my_method = "ClustalOmega") )

#Remove unwanted characters
list_several_high <- do.call(c, msa_consensus_high) %>% 
  str_remove_all("[^AUCG]") 
#Keep info on clustered motifs
names(clustered_high) <-  list_several_high

#Filter from single hits the long motifs that only match themselves but match with others
to_filter_in_final_high <- clustered_high %>% do.call(c,.)
final_high <- final_high[!(final_high %in% to_filter_in_final_high)]

highstab_final <- final_high %>% do.call(c, .) %>% c(., list_several_high) %>%
  unique()
}

#######
lowstab_seq <- c(a549_slam_all_low[,2],
                  a549_slam_one_low[,2],
                  a549_tripseq_all_low[,2],
                  a549_tripseq_one_low[,2]) %>%
  unique()

notOK <- c(lowstab_seq[str_detect(lowstab_seq, "AAAAAA")],
           lowstab_seq[str_detect(lowstab_seq, "GGGGGG")],
           lowstab_seq[str_detect(lowstab_seq, "UUUUUU")],
           lowstab_seq[str_detect(lowstab_seq, "CCCCCC")])

lowstab_seq <- lowstab_seq[!(lowstab_seq %in% notOK)]

###
#Get motifs matching each other
self_match_low <- sapply(lowstab_seq, function(i) lowstab_seq[str_detect(lowstab_seq, i)])

#No match
final_low <- self_match_low[lapply(self_match_low, length) == 1]

#Matches
several_low <- self_match_low[lapply(self_match_low,length) >1]

if ( all(lapply(several_low,  length) ==  2)) {
  #No need to cluster, keep shortest
  list_several_low <- lapply(several_low, min) %>% do.call(c, .)
  lowstab_final <- final_low %>% do.call(c, .) %>% c(., list_several_low) %>%
  unique()
} else {
  
#Cluster them
clustered_low <- sapply(several_low, 
                    function(x) unique(unlist(several_low[sapply(several_low, 
                                                             function(y) any(x %in% y))]))) %>% unique
msa_consensus_low <- lapply(clustered_low, function(x) my_msa(x, my_method = "ClustalOmega") )
to_filter_in_final_low <- clustered_low %>% do.call(c,.)
final_low <- final_low[!(final_low %in% to_filter_in_final_low)]
list_several_low <- do.call(c, msa_consensus_low) %>% 
  str_remove_all("[^AUCG]") 
names(clustered_low) <-  list_several_low
lowstab_final <- final_low %>% do.call(c, .) %>% c(., list_several_low) %>%
  unique()
}
#####

#Remove highstab in lowstab, use full lowstab list 
all_for_filter <- c(lowstab_seq, lowstab_final) %>% unique()
low_filter <- lapply(all_for_filter, function(i) highstab_final[(str_detect(highstab_final, i))])
names(low_filter) <- all_for_filter
#Doesn't handle no match, but very unlikely

#If there is a match length == 1
low_filter <- low_filter[lapply(low_filter, length) == 1]
low_in_high <- low_filter
low_filter <- do.call(c, low_filter)
highstab_final <- highstab_final[!(highstab_final %in% low_filter)]
```

Write final table of motifs
```{r write, echo = False}
write.table(highstab_final, paste0(out_dir,"/highstab.list"),
            col.names = F, row.names = F, quote = F, sep = "\n")



write.table(lowstab_final, paste0(out_dir,"/lowstab.list"),
            col.names = F, row.names = F, quote = F, sep = "\n")

```



Creating final source of motifs table 
```{r source, echo = False}
highstab_matrix <- bind_rows(a549_slam_all_high=a549_slam_all_high[,2:3],
                  a549_slam_one_high=a549_slam_one_high[,2:3],
                  a549_tripseq_all_high=a549_tripseq_all_high[,2:3],
                  a549_tripseq_one_high=a549_tripseq_one_high[,2:3],
                  hepg2_slam_all_high=hepg2_slam_all_high[,2:3],
                  hepg2_slam_one_high=hepg2_slam_one_high[,2:3],
                  hepg2_tripseq_all_high=hepg2_tripseq_all_high[,2:3],
                  hepg2_tripseq_one_high=hepg2_tripseq_one_high[,2:3], .id = "source_pipeline")


#Checking that non clustered motifs are not in clustered ones 
if (any(final_high %in%  (clustered_high %>% do.call(c, .)))) {
  stop("Error something went wrong during clustering of motifs")
}

#Generate final source list, 
#One of the final list (without shared lowstab motifs)
highstab_final_source <- c(lapply(clustered_high[!(names(clustered_high) %in% low_filter)],  function(x) 
  highstab_matrix[highstab_matrix$sequence %in% x,]),
  lapply(final_high[(!final_high %in% low_filter)], function(x) 
  highstab_matrix[highstab_matrix$sequence %in% x,]
  )) %>% 
  bind_rows(.id = "final_motif")

all(highstab_final %in% highstab_final_source$final_motif)


#Create one row per entry
highstab_final_source <- separate_rows(highstab_final_source, multiple_source, sep = ",") %>%
  unique()

##LOW
lowstab_matrix <- bind_rows(a549_slam_all_low=a549_slam_all_low[,2:3],
                  a549_slam_one_low=a549_slam_one_low[,2:3],
                  a549_tripseq_all_low=a549_tripseq_all_low[,2:3],
                  a549_tripseq_one_low=a549_tripseq_one_low[,2:3],
                  hepg2_slam_all_low=hepg2_slam_all_low[,2:3],
                  hepg2_slam_one_low=hepg2_slam_one_low[,2:3],
                  hepg2_tripseq_all_low=hepg2_tripseq_all_low[,2:3],
                  hepg2_tripseq_one_low=hepg2_tripseq_one_low[,2:3], .id = "source_pipeline")

#generate final source list, with lowstab motifs still in there
lowstab_final_source <- c(lapply(clustered_low,  function(x) 
  lowstab_matrix[lowstab_matrix$sequence %in% x,]),
  lapply(final_low, function(x) 
  lowstab_matrix[lowstab_matrix$sequence %in% x,]
  )) %>% 
  bind_rows(.id = "final_motif")
lowstab_final_source <- separate_rows(lowstab_final_source, multiple_source, sep = ",") %>%
  unique()
all(lowstab_final %in% lowstab_final_source$final_motif)


##Lowstab in Highstab
if (all(lapply(low_in_high, length) == 1)) {
  table_low_in_high <- data.frame(
    high_motif = do.call(c, low_in_high)
  ) %>%
    rownames_to_column(var = "low_motif")
} else {
 table_low_in_high <- low_in_high %>% bind_cols(.id = "low_motif")
}

table_low_in_high <- merge(lowstab_matrix, table_low_in_high, by.x = "sequence", by.y = "low_motif", all.y = T)
colnames(table_low_in_high) <- c("matched_lowstab_motif", "source_pipeline_low", "multiple_source_low", "macthed_highstab_motif")


table_low_in_high <- table_low_in_high %>%
  merge(., y = highstab_matrix, by.x = "macthed_highstab_motif", by.y = "sequence", all.x = T)

if (any(is.na(table_low_in_high))) {
  #One match in the low comes from a clustered consensus sequence not 
  #in the original lowstab_matrix
na_results <- table_low_in_high[rowSums(is.na(table_low_in_high)) > 0, colSums(is.na(table_low_in_high)) == 0]
na_results <- merge(na_results, lowstab_final_source, by.x = "matched_lowstab_motif", by.y = "final_motif",
      suffixes = c("_high", "_low"))
names(na_results)[names(na_results) == "sequence"] <- "original_sequence_low"
table_low_in_high <- table_low_in_high[rowSums(is.na(table_low_in_high)) == 0,]

table_low_in_high <- full_join(na_results, table_low_in_high, by = c("matched_lowstab_motif" = "matched_lowstab_motif" ,
                                                "macthed_highstab_motif" = "macthed_highstab_motif",
                                                "source_pipeline_low" =  "source_pipeline_low" ,
                                                "source_pipeline_high" = "source_pipeline" ,
                                                "multiple_source_high" = "multiple_source"))
}



write.table(highstab_final_source, paste0(out_dir,"/highstab_motifs_source.tsv"),
            col.names = T, row.names = F, quote = F, sep = "\t")


write.table(lowstab_final_source, paste0(out_dir,"/lowstab_motifs_source.tsv"),
            col.names = T, row.names = F, quote = F, sep = "\t")


write.table(table_low_in_high, paste0(out_dir,"/highstab_in_lowstab_motifs_source.tsv"),
            col.names = T, row.names = F, quote = F, sep = "\t")

```



# Reporting 

At the begining we had: <br>

* `r nrow(highstab_matrix)` high stability motifs, <br>
* `r nrow(lowstab_matrix)` low stability motifs.

After clustering and merging similar motifs, we had: <br>

* `r length(highstab_final)` high stability motifs, <br>
* `r length(lowstab_final)` low stability motifs, <br>
* `r length(low_in_high)` high stability motifs matching low stability ones. <br>
